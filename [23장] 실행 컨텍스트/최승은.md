# 23장 실행 컨텍스트 (Execution Context)

> **실행 컨텍스트**: 자바스크립트 코드가 실행되기 위해 필요한 \*\*환경 정보(스코프, this, 변수, 함수 선언 등)\*\*를 담고 관리하는 객체.
> 모든 코드 실행은 실행 컨텍스트를 통해 이뤄진다.

---

## 23.1 소스코드의 타입

| 타입          | 설명                                  | 실행 컨텍스트 생성 시점 |
| ----------- | ----------------------------------- | ------------- |
| **전역 코드**   | 전역에 존재하는 소스코드 (전역 함수/클래스 내부 제외)     | 전역 실행 컨텍스트    |
| **함수 코드**   | 함수 내부의 소스코드 (내부 중첩 함수 제외)           | 함수 실행 컨텍스트    |
| **eval 코드** | `eval()`로 실행되는 코드                   | eval 실행 컨텍스트  |
| **모듈 코드**   | 모듈 스코프에서 실행되는 코드 (import/export 포함) | 모듈 실행 컨텍스트    |

- 실행 컨텍스트는 코드의 **범위 단위**마다 독립적으로 생성됨.

---

## 23.2 소스코드의 평가와 실행

자바스크립트 엔진은 코드를 두 단계로 처리한다:

1. **평가 단계 (Compile-like)**

   * 실행 컨텍스트 생성
   * 변수, 함수 선언문 등만 먼저 등록
   * 스코프(렉시컬 환경)에 식별자 저장

2. **실행 단계 (Runtime)**

   * 나머지 코드 실행 (할당문, 함수 호출 등)
   * 평가 단계에서 준비된 식별자를 사용

---

## 23.3 실행 컨텍스트의 역할

1. **전역 코드 평가**

   * 전역 실행 컨텍스트 생성
   * 전역 변수/함수 등록

2. **전역 코드 실행**

   * 전역 코드 순차 실행
   * 함수 호출 시 전역 실행 중단 → 함수 내부 진입

3. **함수 코드 평가**

   * 함수 실행 컨텍스트 생성
   * 지역 변수, 매개변수, arguments 등록

4. **함수 코드 실행**

   * 순차적으로 실행
   * 함수 종료 시 컨텍스트 스택에서 제거

👉 실행 컨텍스트는 결국 **스코프 관리(렉시컬 환경)** + **코드 실행 순서 관리(스택)** 역할을 한다.

---

## 23.4 실행 컨텍스트 스택

* 실행 컨텍스트는 **스택 구조**로 관리된다.
* 최상위에 있는 컨텍스트가 현재 실행 중인 컨텍스트.

```js
const x = 1;

function foo () { 
  const y = 2;
  function bar () {
    const z = 3; 
    console.log(x + y + z);
  }
  bar();
}
foo(); // 6
```

실행 순서:

1. 전역 컨텍스트 생성 → push
2. foo 실행 컨텍스트 생성 → push
3. bar 실행 컨텍스트 생성 → push
4. bar 종료 → pop
5. foo 종료 → pop
6. 전역 종료 → pop

👉 실행 컨텍스트 스택은 \*\*콜 스택(Call Stack)\*\*과 동일한 개념.

---

## 23.5 렉시컬 환경

* 실행 컨텍스트의 핵심 구성 요소
* **식별자(변수/함수)와 바인딩된 값**을 저장하는 자료구조
* 구성 요소:

  1. **환경 레코드**: 실제 변수/함수 바인딩 저장소
  2. **외부 렉시컬 환경에 대한 참조**: 상위 스코프 참조

👉 실행 컨텍스트 스택이 \*\*흐름(순서)\*\*를 관리한다면,
렉시컬 환경은 **변수 스코프**를 관리한다.

---

## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정

### 1) 전역 객체 생성

* 코드 로드 전에 전역 객체(Global Object) 먼저 생성
* 빌트인 객체(Math, Object 등) 포함

### 2) 전역 코드 평가

* 전역 실행 컨텍스트 생성 → 스택 push
* 전역 렉시컬 환경 생성

  * 전역 환경 레코드: 전역 변수/함수 저장

    * **객체 환경 레코드**: `var`, 함수 선언 → 전역 객체에 등록
    * **선언적 환경 레코드**: `let`, `const` (TDZ 관리)
  * this 바인딩 (`window` / `global` / `undefined` in strict)
  * 외부 렉시컬 환경 참조 = null (스코프 종점)

### 3) 전역 코드 실행

* 변수/함수 실행
* 식별자 검색 → 현재 렉시컬 환경 → 외부 렉시컬 환경 순으로 탐색 (스코프 체인)

### 4) 함수 코드 평가

* 함수 실행 시점에 함수 실행 컨텍스트 생성
* 함수 렉시컬 환경 생성

  * 환경 레코드: 매개변수, arguments, 지역 변수, 중첩 함수
  * this 바인딩 결정
  * 외부 렉시컬 환경 참조 = 함수 정의 당시의 상위 스코프

### 5) 함수 코드 실행

* 함수 내부 실행
* 식별자 검색 시 → 함수 렉시컬 환경 → 상위 스코프 순서로 탐색

### 6) 함수 종료

* 실행 컨텍스트 스택에서 제거
* GC 대상: 단, **클로저가 참조 중이면 메모리에 유지됨**

---

## 23.7 실행 컨텍스트와 블록 레벨 스코프

* ES6부터 `{ }` 블록도 스코프를 가진다 (let/const).
* 블록 실행 시, **선언적 환경 레코드**를 갖는 새로운 렉시컬 환경 생성.
* 외부 참조는 기존 스코프를 가리킴.

```js
let x = 1;

if (true) {
  let x = 10; // 블록 스코프
  console.log(x); // 10
}
console.log(x); // 1
```

- `var`는 함수 레벨 스코프 → 블록 무시.
- `let`, `const`는 블록 레벨 스코프 → TDZ와 함께 안전하게 동작.
